'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

let runWMIC = (() => {
    var _ref = (0, _asyncToGenerator3.default)(function* (args) {
        const wmicProcess = (0, _child_process.spawn)('wmic.exe', args, { detached: true });

        let wmicOutput = '';

        wmicProcess.stdout.on('data', function (data) {
            wmicOutput += data.toString();
        });

        try {
            yield _pinkie2.default.race([(0, _promisifyEvent2.default)(wmicProcess.stdout, 'end'), (0, _promisifyEvent2.default)(wmicProcess, 'error')]);

            return wmicOutput;
        } catch (e) {
            return '';
        }
    });

    return function runWMIC(_x) {
        return _ref.apply(this, arguments);
    };
})();

let findProcessWin = (() => {
    var _ref2 = (0, _asyncToGenerator3.default)(function* (processOptions) {
        const wmicArgs = ['process', 'where', `commandline like '%${processOptions.arguments}%' and name <> 'cmd.exe' and name <> 'wmic.exe'`, 'get', 'processid'];
        const wmicOutput = yield runWMIC(wmicArgs);
        let processList = wmicOutput.split(/\s*\n/);

        processList = processList
        // NOTE: remove list's header and empty last element, caused by trailing newline
        .slice(1, -1).map(function (pid) {
            return { pid: Number(pid) };
        });

        return processList;
    });

    return function findProcessWin(_x2) {
        return _ref2.apply(this, arguments);
    };
})();

var _child_process = require('child_process');

var _osFamily = require('os-family');

var _osFamily2 = _interopRequireDefault(_osFamily);

var _promisifyEvent = require('promisify-event');

var _promisifyEvent2 = _interopRequireDefault(_promisifyEvent);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _promisifiedFunctions = require('./promisified-functions');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const BROWSER_CLOSING_TIMEOUT = 5;

exports.default = (() => {
    var _ref3 = (0, _asyncToGenerator3.default)(function* (browserId) {
        const processOptions = { arguments: browserId, psargs: '-ef' };
        const processList = _osFamily2.default.win ? yield findProcessWin(processOptions) : yield (0, _promisifiedFunctions.findProcess)(processOptions);

        if (!processList.length) return true;

        try {
            if (_osFamily2.default.win) process.kill(processList[0].pid);else yield (0, _promisifiedFunctions.killProcess)(processList[0].pid, { timeout: BROWSER_CLOSING_TIMEOUT });

            return true;
        } catch (e) {
            return false;
        }
    });

    return function (_x3) {
        return _ref3.apply(this, arguments);
    };
})();

module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9raWxsLWJyb3dzZXItcHJvY2Vzcy5qcyJdLCJuYW1lcyI6WyJhcmdzIiwid21pY1Byb2Nlc3MiLCJkZXRhY2hlZCIsIndtaWNPdXRwdXQiLCJzdGRvdXQiLCJvbiIsImRhdGEiLCJ0b1N0cmluZyIsIlByb21pc2UiLCJyYWNlIiwiZSIsInJ1bldNSUMiLCJwcm9jZXNzT3B0aW9ucyIsIndtaWNBcmdzIiwiYXJndW1lbnRzIiwicHJvY2Vzc0xpc3QiLCJzcGxpdCIsInNsaWNlIiwibWFwIiwicGlkIiwiTnVtYmVyIiwiZmluZFByb2Nlc3NXaW4iLCJCUk9XU0VSX0NMT1NJTkdfVElNRU9VVCIsImJyb3dzZXJJZCIsInBzYXJncyIsIk9TIiwid2luIiwibGVuZ3RoIiwicHJvY2VzcyIsImtpbGwiLCJ0aW1lb3V0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7K0NBU0EsV0FBd0JBLElBQXhCLEVBQThCO0FBQzFCLGNBQU1DLGNBQWMsMEJBQU0sVUFBTixFQUFrQkQsSUFBbEIsRUFBd0IsRUFBRUUsVUFBVSxJQUFaLEVBQXhCLENBQXBCOztBQUVBLFlBQUlDLGFBQWMsRUFBbEI7O0FBRUFGLG9CQUFZRyxNQUFaLENBQW1CQyxFQUFuQixDQUFzQixNQUF0QixFQUE4QixnQkFBUTtBQUNsQ0YsMEJBQWNHLEtBQUtDLFFBQUwsRUFBZDtBQUNILFNBRkQ7O0FBSUEsWUFBSTtBQUNBLGtCQUFNQyxpQkFBUUMsSUFBUixDQUFhLENBQ2YsOEJBQWVSLFlBQVlHLE1BQTNCLEVBQW1DLEtBQW5DLENBRGUsRUFFZiw4QkFBZUgsV0FBZixFQUE0QixPQUE1QixDQUZlLENBQWIsQ0FBTjs7QUFLQSxtQkFBT0UsVUFBUDtBQUNILFNBUEQsQ0FRQSxPQUFPTyxDQUFQLEVBQVU7QUFDTixtQkFBTyxFQUFQO0FBQ0g7QUFDSixLOztvQkFwQmNDLE87Ozs7OztnREFzQmYsV0FBK0JDLGNBQS9CLEVBQStDO0FBQzNDLGNBQU1DLFdBQWMsQ0FBQyxTQUFELEVBQVksT0FBWixFQUFzQixzQkFBcUJELGVBQWVFLFNBQVUsaURBQXBFLEVBQXNILEtBQXRILEVBQTZILFdBQTdILENBQXBCO0FBQ0EsY0FBTVgsYUFBYyxNQUFNUSxRQUFRRSxRQUFSLENBQTFCO0FBQ0EsWUFBSUUsY0FBY1osV0FBV2EsS0FBWCxDQUFpQixPQUFqQixDQUFsQjs7QUFFQUQsc0JBQWNBO0FBQ1Y7QUFEVSxTQUVURSxLQUZTLENBRUgsQ0FGRyxFQUVBLENBQUMsQ0FGRCxFQUdUQyxHQUhTLENBR0w7QUFBQSxtQkFBUSxFQUFFQyxLQUFLQyxPQUFPRCxHQUFQLENBQVAsRUFBUjtBQUFBLFNBSEssQ0FBZDs7QUFLQSxlQUFPSixXQUFQO0FBQ0gsSzs7b0JBWGNNLGM7Ozs7O0FBL0JmOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBR0EsTUFBTUMsMEJBQTBCLENBQWhDOzs7Z0RBcUNlLFdBQWdCQyxTQUFoQixFQUEyQjtBQUN0QyxjQUFNWCxpQkFBaUIsRUFBRUUsV0FBV1MsU0FBYixFQUF3QkMsUUFBUSxLQUFoQyxFQUF2QjtBQUNBLGNBQU1ULGNBQWlCVSxtQkFBR0MsR0FBSCxHQUFTLE1BQU1MLGVBQWVULGNBQWYsQ0FBZixHQUFnRCxNQUFNLHVDQUFZQSxjQUFaLENBQTdFOztBQUVBLFlBQUksQ0FBQ0csWUFBWVksTUFBakIsRUFDSSxPQUFPLElBQVA7O0FBRUosWUFBSTtBQUNBLGdCQUFJRixtQkFBR0MsR0FBUCxFQUNJRSxRQUFRQyxJQUFSLENBQWFkLFlBQVksQ0FBWixFQUFlSSxHQUE1QixFQURKLEtBR0ksTUFBTSx1Q0FBWUosWUFBWSxDQUFaLEVBQWVJLEdBQTNCLEVBQWdDLEVBQUVXLFNBQVNSLHVCQUFYLEVBQWhDLENBQU47O0FBRUosbUJBQU8sSUFBUDtBQUNILFNBUEQsQ0FRQSxPQUFPWixDQUFQLEVBQVU7QUFDTixtQkFBTyxLQUFQO0FBQ0g7QUFDSixLIiwiZmlsZSI6InV0aWxzL2tpbGwtYnJvd3Nlci1wcm9jZXNzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgc3Bhd24gfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCBPUyBmcm9tICdvcy1mYW1pbHknO1xuaW1wb3J0IHByb21pc2lmeUV2ZW50IGZyb20gJ3Byb21pc2lmeS1ldmVudCc7XG5pbXBvcnQgUHJvbWlzZSBmcm9tICdwaW5raWUnO1xuaW1wb3J0IHsgZmluZFByb2Nlc3MsIGtpbGxQcm9jZXNzIH0gZnJvbSAnLi9wcm9taXNpZmllZC1mdW5jdGlvbnMnO1xuXG5cbmNvbnN0IEJST1dTRVJfQ0xPU0lOR19USU1FT1VUID0gNTtcblxuYXN5bmMgZnVuY3Rpb24gcnVuV01JQyAoYXJncykge1xuICAgIGNvbnN0IHdtaWNQcm9jZXNzID0gc3Bhd24oJ3dtaWMuZXhlJywgYXJncywgeyBkZXRhY2hlZDogdHJ1ZSB9KTtcblxuICAgIGxldCB3bWljT3V0cHV0ICA9ICcnO1xuXG4gICAgd21pY1Byb2Nlc3Muc3Rkb3V0Lm9uKCdkYXRhJywgZGF0YSA9PiB7XG4gICAgICAgIHdtaWNPdXRwdXQgKz0gZGF0YS50b1N0cmluZygpO1xuICAgIH0pO1xuXG4gICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgUHJvbWlzZS5yYWNlKFtcbiAgICAgICAgICAgIHByb21pc2lmeUV2ZW50KHdtaWNQcm9jZXNzLnN0ZG91dCwgJ2VuZCcpLFxuICAgICAgICAgICAgcHJvbWlzaWZ5RXZlbnQod21pY1Byb2Nlc3MsICdlcnJvcicpXG4gICAgICAgIF0pO1xuXG4gICAgICAgIHJldHVybiB3bWljT3V0cHV0O1xuICAgIH1cbiAgICBjYXRjaCAoZSkge1xuICAgICAgICByZXR1cm4gJyc7XG4gICAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBmaW5kUHJvY2Vzc1dpbiAocHJvY2Vzc09wdGlvbnMpIHtcbiAgICBjb25zdCB3bWljQXJncyAgICA9IFsncHJvY2VzcycsICd3aGVyZScsIGBjb21tYW5kbGluZSBsaWtlICclJHtwcm9jZXNzT3B0aW9ucy5hcmd1bWVudHN9JScgYW5kIG5hbWUgPD4gJ2NtZC5leGUnIGFuZCBuYW1lIDw+ICd3bWljLmV4ZSdgLCAnZ2V0JywgJ3Byb2Nlc3NpZCddO1xuICAgIGNvbnN0IHdtaWNPdXRwdXQgID0gYXdhaXQgcnVuV01JQyh3bWljQXJncyk7XG4gICAgbGV0IHByb2Nlc3NMaXN0ID0gd21pY091dHB1dC5zcGxpdCgvXFxzKlxcbi8pO1xuXG4gICAgcHJvY2Vzc0xpc3QgPSBwcm9jZXNzTGlzdFxuICAgICAgICAvLyBOT1RFOiByZW1vdmUgbGlzdCdzIGhlYWRlciBhbmQgZW1wdHkgbGFzdCBlbGVtZW50LCBjYXVzZWQgYnkgdHJhaWxpbmcgbmV3bGluZVxuICAgICAgICAuc2xpY2UoMSwgLTEpXG4gICAgICAgIC5tYXAocGlkID0+ICh7IHBpZDogTnVtYmVyKHBpZCkgfSkpO1xuXG4gICAgcmV0dXJuIHByb2Nlc3NMaXN0O1xufVxuXG5leHBvcnQgZGVmYXVsdCBhc3luYyBmdW5jdGlvbiAoYnJvd3NlcklkKSB7XG4gICAgY29uc3QgcHJvY2Vzc09wdGlvbnMgPSB7IGFyZ3VtZW50czogYnJvd3NlcklkLCBwc2FyZ3M6ICctZWYnIH07XG4gICAgY29uc3QgcHJvY2Vzc0xpc3QgICAgPSBPUy53aW4gPyBhd2FpdCBmaW5kUHJvY2Vzc1dpbihwcm9jZXNzT3B0aW9ucykgOiBhd2FpdCBmaW5kUHJvY2Vzcyhwcm9jZXNzT3B0aW9ucyk7XG5cbiAgICBpZiAoIXByb2Nlc3NMaXN0Lmxlbmd0aClcbiAgICAgICAgcmV0dXJuIHRydWU7XG5cbiAgICB0cnkge1xuICAgICAgICBpZiAoT1Mud2luKVxuICAgICAgICAgICAgcHJvY2Vzcy5raWxsKHByb2Nlc3NMaXN0WzBdLnBpZCk7XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIGF3YWl0IGtpbGxQcm9jZXNzKHByb2Nlc3NMaXN0WzBdLnBpZCwgeyB0aW1lb3V0OiBCUk9XU0VSX0NMT1NJTkdfVElNRU9VVCB9KTtcblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbn1cbiJdfQ==
